# 第一章 概论

## 计算机网络与Internet

## 互联网的组成

- 边缘部分

    由所有连接在互联网上的主机组成
- 核心部分

    由大量网络和连接这些网络的路由器组成，为边缘部分提供服务

### 边缘部分

边缘部分就是主机，又称为**端系统**

端系统的两种工作方式
- C/S 客户/服务器
- P2P 对等体

#### 客户/服务器工作方式

客户向服务器发出请求服务，服务器向客户提供服务

#### 对等连接工作方式

不区分服务请求方、提供方，两个主机都运行P2P软件，每一个主机既是客户又是服务器，是C/S的特例

### 核心部分

网络中的核心部分要向网络边缘中的大量主机提供连通性，使边缘部分中的任何一个主机都能够向其他主机通信

在网络核心部分起特殊作用的是路由器

### 路由器

路由器是实现**分组交换**的关键构建，其任务是转发收到的分组，这是网络核心部分最重要的功能

核心部分有不同的交换方式
- 电路交换
- 存储转发交换（分组交换）

#### 交换的含义

交换的含义就是转接——把一条电话线转接到另一条电话线，使它们连通起来

从通信资源的分配角度来看，交换就是按照某种方式动态的分配传传输线路的资源

### 电路交换

电路交换网是指通信子网借鉴的电信网络语音通话的思路，用面向连接方式来实现数据报的投递

#### 电路交换的工作过程

电路交换必定是面向连接的

- 电路交换的三个阶段
    - 建立连接
    - 通信
    - 释放连接

#### 电路交换的优缺点

- 优点

    一旦建立了一条连接，通信过程使独占信道的，通信质量是有保障的
- 缺点
    - 计算机数据具有突发性，不适合
    - 通信线路的利用率很低

### 分组交换

分组交换网就是指，通信子网采用存储转发技术来实现数据包的投递，这里数据包有固定的格式，称为分组

#### 分组交换的工作过程

1. 划分成较短时间段：在发送端，先把较长的报文划分成较短的、固定长度的数据段
2. 添加首部构成分组：在每一个数据段前添加上首部构成分组
3. 依次送出分组：依次把各分组发送到接收端
4. 收到分组后剥去首部：接收端收到分组后剥去首部还原成报文
5. 最后还原成原来的报文：最后在接收端把收到的数据恢复成为原来的报文

#### 分组交换的优缺点

- 优点

    高效、灵活、迅速、可靠
- 缺点

    分组在各节点存储转发时需要排队，造成一定时延；分组必须携带的首部造成了一定的开销

## 计算机网络的分类与性能指标

### 分类

#### 按分布范围分类

广域网WAN，城域网MAN，局域网LAN，个人局域网PAN

#### 按拓扑结构分类

星型网络，总线型网络，环形网络，网状型网络

#### 按信道传输技术分类

广播式信道网络、点对点信道网络

#### 按网络的使用者分类

公用网、专用网

#### 按数据交换技术分类

电路交换网络、报文交换网络、分组交换网络

### 计算机网络的性能指标

主要包括：速率、带宽、吞吐率、时延、时延带宽积、往返时间、利用率

#### 速率

指数据的传送速率，单位时bit/s，即bps

#### 带宽

有两种不同意义
- 信号具有的频带宽度，单位是赫
- 单位时间内网络中的某信道能通过的最高数据率，单位是bps

#### 吞吐量

表示在单位时间内通过某个网络的数据量，受网络的带宽或网络的额定速率的限制

#### 时延

指数据从网络的一段传送到另一端所需的时间，有时也称延迟或迟延

网络中的时延由以下几个不同的部分组成：
- 发送时延

    也称传输时延，表示从发送数据帧的第一个比特算起，到该帧的最后一个比特发送完毕所需的时间
- 传播时延

    电磁波在信道中传播一定距离而花费的时间
- 处理时延

    主机或路由器在收到分组时，为处理分组所花费的时间
- 排队时延

    分组在路由器输入输出队列中排队等待处理所花费的时间

数据在网络中经理的总时延就是发送时延、传播时延、处理时延和排队时延之和

#### 时延带宽积

又称以比特为单位的链路长度

时延带宽积 = 传播时延 * 带宽

#### 往返时间(RTT)

往返时间表示从发送方发送数据开始，到发送方收到来自接收方的确认，总共经历的时间

#### 利用率

分为信道利用率和网络利用率

- 信道利用率

    指某信道有百分之几的时间是被利用的，完全空闲的信道的利用率是0
- 网络利用率

    全网络的信道利用率的加权平均值

根据排队论的理论，某信道的利用率增大时，该信道引起的时延也就迅速增加

若令D0表示网络空闲时的时延，D表示网络当前的时延，U表示网络的利用率，则有  
D = D0 / (1 - U)

## 计算机网络体系结构

有两种国际标准，OSI和TCP/IP，OSI是法律上的国际标准，TCP/IP是事实上的国际标准

通常采用折中的方法，综合OSI和TCP/IP的优点，采用一种只有五层的体系结构

即：物理层、数据链路层、网络层、运输层、应用层

### 网络协议

#### 三个组成要素

- 语法：数据与控制信息的结构或格式
- 语义：需要发出何种控制信息，完成何种动作以及做出何种响应
- 同步：事件实现顺序的详细说明

#### 实体、协议、服务和服务访问点

实体表示任何可发送或接收信息的硬件或软件进程

协议是控制两个对等实体进行通信的规则的集合

在协议的控制下，两个对等实体间的通信使得本层能够向上一层提供服务，要实现本层协议，还需要使用下层所提供的服务

同一系统相邻两层的实体进行交互的地方，称为服务访问点。实际上就是一个逻辑接口

通讯子网最多包括底3层，端系统包括完整的5层

# 第二章 物理层

## 物理层的基本概念、数据通讯的基本知识

### 物理层的基本概念

- 物理层考虑的是怎样在连接各计算机的传输媒体上传输数据比特流，而不是指具体的传输媒体
- 物理层的作用就是要尽可能的屏蔽掉不同传输媒体和通信手段的差异
- 用于物理层的协议也常称为物理层规程

### 物理层的主要任务

确定与传输媒体的接口的一些特性

- 机械特性：指明接口所用的接线器形状、尺寸、引线数目等
- 电器特性：指明接口电缆的各条线上出现的电压的范围
- 功能特性：指明某条线上出现的某一电平的电压表示何种意义
- 过程特性：指明对于不同功能的各种可能时间出现的顺序

## 数据通信系统的模型

一个数据通信系统包括三大部分：原系统、传输系统、目的系统

### 数据和信号

- 数据：传送信息的实体
- 信号：数据的电气或电磁的表现
    - 数字信号（基带信号）
    - 模拟信号（频带信号）

### 调制和编码

调制：将数据转换为模拟信号的过程  
编码：将数据转换为数字信号的过程

#### 常用编码方式

1. 不归零制：正电平代表1，负电平代表0
2. 归零制：正脉冲代表1，负脉冲代表0
3. 曼彻斯特编码：位周期中心的向上跳变代表0，向下跳变代表1，但也可以反过来定义
4. 差分曼彻斯特编码：在每一位的中心处始终都有跳变，位开始边界有跳变代表0，没有跳变代表1

曼彻斯特编码和差分曼彻斯特编码产生的信号频率比不归零制高，不归零制不能信号波形本身中提取信号时钟频率，而曼彻斯特编码和差分曼彻斯特编码具有自同步能力

#### 带通调制

使用载波进行调制，把基带信号的频率范围搬移到较高的频段，并转换为模拟信号

最基本的二元制调制方法有：
- 调幅
- 调频
- 调相

## 信道的极限传输速率、香农定理

码元：在使用时间域的波形表示数字信号时，代表不同离散数值的基本波形

速率：
- 波特率：又称为码元传输速率，表示单位时间内数字通信系统所传输的码元个数
- 比特率：信息传输速率

### 奈奎斯特定理

在理想条件下，码元的传输速率的上限值

Cmax = f采样 * log2(N) = 2f * log2(N) bps

f表示理想低通信道的带宽，f采样必须大于等于2f

### 香农定理

推导出带宽受限，有噪声干扰的实际信道的极限信息传输速率

C = W * log2(1+S/N) bps

C为信道的极限信息传输速率，W为信道的带宽，S/N为 信噪比=10log10(S/N)

香农公式表明：
1. 要使信息的极限传输速率提高，就必须提高信道的带宽或信道中的信噪比
2. 只要信息的传输速率低于信道的极限传输速率，就一定能找到某种方法来提高
3. 实际信道的传输速率比极限速率低不少

## 物理层下面的传输介质

传输介质：数据传输系统中在发送器和接收器之间的物理通路

传输介质可分为两大类

- 导向型传输介质（有线）
    - 双绞线
    - 同轴电缆
    - 光纤

- 非导向型传输介质（无线）
    短波、微博、卫星、激光通信等

### 双绞线

双绞线既可以传输模拟信号，又可以传输数字信号

传输距离太远时，分别需要放大器和中继器来进行信号的增强、放大

### 同轴电缆

具有很好的抗干扰特性，被广泛用于传输较高速率的数据

带宽取决于电缆的质量

50Ω同轴电缆用于LAN/数字传输，75Ω同轴电缆用于有线电视/模拟传输

### 光纤

光纤的优点是：
1. 通信容量非常大
2. 传输损耗小，中继距离长
3. 抗雷电和电磁干扰性能好
4. 无串音干扰，保密性好
5. 体积小，重量轻

## 信道复用技术

复用是通信技术中的基本概念，允许用户使用一个共享信道进行通信，降低成本，提高利用率

信道复用技术有：
- 频分复用FDM
- 波分复用WDM
- 时分复用TDM、统计时分复用STDM
- 码分复用CDM

### 频分复用

将整个带宽分为多份，用户在分配到一定的频带后，在通信过程中自始至终都占用这个频带

### 时分复用

将时间划分为一段段等长的时分复用帧，每一个时分复用的用户在每一个TDM帧中占用固定序号的时隙，所有用户在不同的时间占用同样的频带宽度

由于计算机数据的突发性质，用户对分配到的子信道的利用率一般是不高的，可能会在成线路资源的浪费

### 统计时分复用

不是固定分配时隙，而是按需动态的分配时隙，可以提高线路的利用率

### 波分复用

光的频分复用，使用一根光纤来同时传输多个光载波信号

### 码分复用

各用户使用经过特殊挑选的不同码型，因此彼此不会造成干扰

## 宽带接入技术、工作在物理层的设备

### 宽带接入技术

电话线接入到互联网的最高速率是56kbps，FCC认为只要双向速率之和超过200kbps就是宽带

从宽带接入的媒体来看可划分为两大类：
- 有线宽带接入
- 无线宽带接入

#### ADSL技术

非对称数字用户线ADSL技术就是用数字技术对现有的模拟电话用户线进行改造，使它能够承载宽带业务

ADSL技术把0~4kHz低端频谱留给传统电话使用，原来没有被利用的高端频谱留给用户上网使用

ADSL的传输距离取决于数据率和用户线的线径，所能得到的最高数据传输速率与实际的用户线上的信噪比密切相关

ADSL的特点：
- 上行和下行带宽做成不对称的
- ADSL在用户线的两端各安装一个ADSL调制解调器
- 我国目前采用的方案是离散多音调DMT调制技术

#### DMT技术

采用频分复用的方法，把40kHz以上一直到1.1MHz的高端频谱划分为许多子信道，其中25个子信道用于上行信道，249个子信道用于下行信道，每个子信道占据4kHz带宽

#### 光纤同轴混合网（HFC网）

HFC网是在目前覆盖面很广的有线电视网CATV的基础上开发的一种居民宽带接入网，对CATV网进行了改造

HFC网将原CATV网中的同轴电缆主干部分改换为光纤，并使用模拟光纤技术，采用光的振幅调制，比使用数字光纤更经济

模拟光纤从头端连接到光纤结点，即光分配结点，在光纤结点光信号被转换为电信号，在光纤结点以下就是同轴电缆

#### FTTx技术

表示Fiber To The... 代表多种宽带光纤接入方式

# 第三章 数据链路层

## 点对点信道

### 数据链路层概述

数据链路层使用的信道主要有以下两种方式：
- 点对点信道：一个发送方，只有一个接收方
- 广播信道：又称为共享信道，多个站点共享一个传输介质，竞争信道，因此必须使用专用的共享信道介质控制协议(MAC)来协调多个主机的数据发送

#### 数据链路和帧

链路是一条无源的点到点的物理线路段，中间没有任何其他的交换结点

数据链路除物理线路外，还必须有通信协议来控制这些数据的传输，把实现这些协议的硬件和软件加到链路上，就构成的数据链路

数据链路层像个数字管道，而在这条数字管道上传输的数据单位是帧

### 帧定界与透明传输

实现数据链路层功能的协议有很多种，但有3个基本问题是共同的
1. 封装成帧：帧同步（帧定界）
2. 透明传输
3. 差错控制

#### 封装成帧

封装成帧就是在一段数据的前后分别添加首部和尾部，然后构成了一个帧，确定帧的界限。首部和尾部的一个重要作用就是进行帧定界

#### 组帧方法

1. 字符计数法

    用一个特殊的字符来表示一帧的开始，然后用一个计数字段来表明该帧包含的字节数

2. 字节填充的首尾定界法

    当数据是由ASCII码组成的文本文件时，帧定界可以使用特殊的帧定界符

    控制字符SOH放在一帧的最前面，表示帧的首部开始，另一个控制字符EOT表示帧的结束

    如果数据中的某个字节的二进制代码恰好和SOH或EOT一样，数据链路层就会错误的找到帧的边界，解决方法是字节填充或字符填充：  
    发送端的数据链路层在数据中出现控制符的前面插入一个转义字符ESC，接收端的数据链路层在将数据送往网络层之前删除插入的转义字符

3. 比特填充的首尾标志法

    使用011111110作为帧开始和结束标志

    发送方在数据帧检测到由5个连续的1，马上再其后插入0；接收方每收到5个连续的1，自动删除后面紧跟的0，依次恢复原始数据

    这种方法又称为零比特填充法

4. 物理编码违例法

    利用物理介质上编码的违法标志来区分帧的开始与结束

### 差错检测

在传输过程中可能会产生比特差错，在一段时间内，传输错误的比特占所传输比特总数的比率称为误码率，误码率和信噪比由很大的关系

#### 循环冗余检验CRC

在发送端，先把数据划分为组，假定每组k个比特，假设待传送的一组数据M=101001(此时k=6)，在M的后面再添加供差错检测的n为冗余码一起发送

冗余码用二进制的模2运算进行2^n乘M的运算，相当于再M后面添加n个0；得到的(k+n)位的数除以事先选定好的长度为(n+1)位的除数P，得出商是Q而余数是R，余数R比除数P少一位，即R是n位；将余数R作为冗余码拼接再数据M后面发送

#### 帧检验序列FCS

在数据后添加上的冗余码被称为帧检验序列FCS，循环冗余检验CRC和帧检验序列FCS并不等同

- CRC是一种常用的检错方法，而FCS是添加在数据后面的冗余码
- FCS可以用CRC这种方法得出，但CRC并非用来获得FCS的唯一方法

#### CRC检验

若得出的余数R=0，则判定这个帧没有差错，就接受，若余数≠0，则判定这个帧有差错，就丢弃

## 广域网的基本概念、PPP协议

广域网是一个单一的网络，使用结点交换机连接各主机而不是用路由器来连接各网络，互联网才采用路由器来连接

### 点对点协议PPP

#### PPP协议应满足的需求

- 简单
- 封装成帧
- 透明性
- 多种网络层协议：能够再同一条物理链路上同时支持多种网络层协议
- 多种类型链路：能够在多种类型的链路上运行
- 差错检测
- 检测连接状态
- 最大传输单元
- 网络层地址协商
- 数据层压缩协商

#### PPP协议不需要的功能

- 纠错
- 流量控制
- 序号
- 多点线路
- 半双工或单工链路

#### PPP协议的组成

1. 一个将IP数据报封装到串行链路的方法
2. 链路控制协议
3. 网络控制协议

#### PPP协议的帧格式

PPP帧的长度都是整数字节，首部和尾部分别位4个字段和2个字段

1. 首位的界定标志字段F=0x7E
2. 地址字段A=0xFF，实际不起作用
3. 控制字段C=0x03
4. 2个字节的协议字段，其值为：
    - 0x0021，信息字段为IP数据报
    - 0x8021，信息字段是网络控制数据
    - 0xC021，信息字段是PPP链路控制数据
    - 0xC023，信息字段是鉴别数据
5. 信息部分，占0~1500个字节
6. 帧检验序列，占两个字节，即冗余码

#### PPP协议的工作状态

### HDLC协议

高级数据链路控制协议，ISO定制、面向比特的早期数据链路协议，而PPP是面向字节的，PPP应使用字节填充，而HDLC协议应使用比特填充

PPP帧比HDLC协议帧多一个2字节的协议字段

## 使用广播信道的数据链路层

### 局域网的数据链路层

局域网最主要的特点是：网络为一个单位所拥有；地理范围和站点数目均有限

局域网具有如下优点：具有广播功能、系统灵活，扩展性好；高可靠性、可用性

### 局域网的技术要素

- 拓扑结构
- 传输介质
- **介质访问控制方法MAC**

#### 拓扑结构

星形网、总线网、环形网

#### 传输介质

局域网的主要传输介质包括：双绞线、铜缆、光纤

其中双绞线为主流传输介质

#### 介质访问方法

局域网的主要MAC方法包括：
- CSMA/CD：经典以太网所采用
- 令牌总线
- 令牌环

前两种作用于总线型网，令牌环作用于环形网

#### 数据链路层的两个子层

- 逻辑链路控制LCC子层
- 媒体接入控制MAC子层

不管采用何种MAC协议的局域网，对LLC子层来说都是透明的，即LLC子层看不见下面的局域网

### 介质访问技术概述、CSMA/CD协议

#### 早期局域网的MAC协议

1. ALOHA协议
2. CSMA协议
3. CSMA/CD协议
4. CSMA/CA协议
5. Token Ring协议

前4种都属于随机型介质访问控制技术，第5种属于轮询访问介质访问控制

#### CSMA/CD协议

最初的以太网将许多计算机连接到一根总线上，以广播方式发送，为了通信的简便，以太网采用了两种重要的措施：
- 无连接的工作方式  
    不必先建立连接就可以直接发送数据  
    对发送的数据帧不进行编号，也不要求对方发回确认

- 以太网发送的数据都是用曼彻斯特编码

以太网提供的服务是不可靠的交付

CSMA/CD的含义是：载波监听多路访问/碰撞检测

多路访问表示许多计算机以多点接入的方式连接再一根总线上

载波监听是指每一个站再发送数据之前 要先检测一下总线上是否有其他计算机在发送数据，如果有则暂时不要发送数据，以免发生碰撞

碰撞检测就是计算机边发送数据边检测信道上的信号电压大小，当一个站检测到的信号电压摆动值超过一定的门限值时，就认为产生了碰撞

一个正在发送数据的站发现总线上出现了碰撞，就要立即停止发送，然后等待一段随机时间后再次发送

使用CSMA/CD协议的以太网不能进行全双工通信而只能进行半双工通信

#### 最短有效帧长

由于10mbps以太网取51.2μs为争用期长度，若前64字节没有发生冲突，则后续的数据就不会发生冲突，如果发生冲突，就一定时在发送的前64字节之内

以太网规定了最短有效帧长为64字节，凡长度小于64字节的帧都是由于冲突而异常终止的无效帧

#### CSMA/CD协议的要点

- 先监听再发送：发送之前必须检测信道，若信道忙则不停的检测直到信道空闲，若检测到信道空闲，并在96比特时间内信道保持空闲，就发送这个帧
- 边发送边监听：在发送过程中仍不停的检测信道

### 以太网的MAC帧

#### MAC层的硬件地址

局域网中的每台计算机都有一个唯一的号码，称为硬件地址、物理地址，或MAC地址

#### 48位的MAC地址

每块网卡出厂即被赋予一个全球唯一的MAC地址，被固化在网卡的ROM中，共48bit

#### MAC帧的格式

常用的以太网MAC帧格式有两种标准：
- DIX Ethernet V2标准
- IEEE的802.3标准

最常用的MAC帧是以太网V2的格式

## 扩展的以太网

### 在物理层扩展

使用光纤扩展、使用集线器扩展

### 在数据链路层扩展

早期使用网桥，现在使用以太网交换机

#### 以太网交换机的特点

- 以太网交换机实质上就是一个多接口的网桥
- 每个接口都直接与一个单台主机或另一个以太网交换机相连，并且一般都工作在全双工方式
- 互相通信的主机都是独占传输媒体，无碰撞的传输数据

#### 以太网交换机的优点

- 用户独享带宽，增加了总容量
- 从共享总线以太网转到交换式以太网时，所有接入设备的软件和硬件、适配器等都不需要做任何改动
- 以太网交换机一般都具有多种速率的接口，方便不同情况的用户

#### 以太网交换机的交换方式

- 存储转发方式：把整个数据帧先缓存后再进行处理
- 直通方式：接收数据帧的同时就立即按数据帧的目的MAC地址决定该帧的转发接口，因而提高帧的转发速率

#### 以太网交换机自学习和转发帧的步骤

- 交换机收到一帧后先进行自学习，查找交换表中与收到帧的源地址有无相匹配的项目
    - 如没有，就在交换表中增加一个项目
    - 如有，则把原有的项目进行更新
- 转发帧，查找交换表中与收到帧的目的地址有无相匹配的项目
    - 如没有，则向所有其他接口转发
    - 如有，则按交换表中给出的接口进行转发
    - 若交换表中给出的接口就是该帧进入交换机的接口，则应丢弃这个帧

### 虚拟局域网VLAN

由一些局域网网段构成的与物理位置无关的逻辑组，每一个VLAN帧都有一个明确的标识符，指明发送这个帧的计算机是属于哪一个VLAN

## 高速以太网

速率达到或超过100mbps的以太网称为高速以太网

# 第四章 网络层

## 网络层提供的两种服务

有两种观点：
- 让网络负责可靠交付

    模仿电信网络，通信前先建立虚电路保证双方通信所需的网络资源，再使用可靠传输的协议

- 让网络提供数据报服务

    网络层向上之提供无连接的、尽最大努力交付的数据报服务，不提供服务质量的承诺

    这种设计思路使网络的造价降低，运行方式灵活

## 网络层IP协议

### 虚拟互联网络的概念

#### 网际协议IP

是TCP/IP体系中最主要的两个协议之一

配套使用的还有三个协议：
- 地址解析协议ARP
- 网际控制报文协议ICMP
- 网际组管理协议IGMP

#### 虚拟互联网络

将网络互相连接起来需要使用一些中间设备，中间设备又称为中间系统或中继系统

有五种不同的中间设备：
- 物理层中继系统：转发器
- 数据链路层中继系统：网桥或桥接器
- 网络层中继系统：路由器
- 网桥和路由器的混合物：桥路器
- 网络层及以上的中继系统：网关

当中继系统是转发器或网桥时，一般并不称之为网络互联，因为这仅仅是把一个网络扩大了，仍然是一个网络

网关由于比较复杂，目前使用较少

**网络互联都是指用路由器进行网络互联和路由选择**，由于历史原因，路由器常被称为网关

#### 虚拟互联网络的意义

虚拟互联网络也就是逻辑互联网络，意思是互联起来的各种物理网络的异构性是客观存在的，但利用IP协议就可以使这些网络从用户看起来好像是一个统一的网络

使用IP协议的虚拟互联网络可以简称为IP网

虚拟互联网络的好处是当互联网上的主机进行通信时，好像在一个网络上通信，而看不见互联的各具体的网络异构细节

在覆盖全球的IP网的上层使用TCP/IP协议，就是现在的互联网

### 分类的IP地址

IP协议的首部规定了IP数据报中IP地址的格式，IP地址的发展分为3个阶段
- 分类的IP地址
- 子网的划分
- 构成超网

在TCP/IP体系中，IP地址是一个最基本的概念，是路由器和每一个接口的重要和唯一标识

把整个因特网看成一个单一的网络，那么IP地址就是给每个连接在互联网上的主机或者路由器的接口，分配一个全世界范围是唯一的32位标识符

将IP地址划分为若干个固定类，每一类地址都由两个固定长度的字段组成，其中一个字段是网络号，标志主机所连接到的网络，另一个字段是主机号，标志该主机

主机号在网络号所指明的网络范围内必须是唯一的

#### 点分十进制记法

机器中存放的IP地址是32位的二进制代码，每8位为一组

eg.：10000000 00001011 00000011 00011111 = 128.11.3.31

#### 分类IP地址的特点

- IP地址这种分级的结构设计有2个好处：
    - IP地址管理机构在分配IP地址时只分配网络号，剩下的主机号由得到该网络号的单位自行分配
    - 路由器仅根据目的主机所连接的网络号来转发分组，不考虑目的主机号，这样使路由表中内容大幅减少

- 实际上IP地址是标志一个主机和一条链路的接口

    由于路由器至少应连接到两个网络才能转发数据报，所以一个路由器至少有两个不同的IP地址

### IP地址与硬件地址

IP地址与硬件地址是不同的地址，从层次的角度看：
- 硬件地址是数据链路层和物理层使用的地址
- IP地址是网络层和以上各层使用的地址，是一种逻辑地址

IP地址放在IP数据报的首部，而硬件地址放在MAC帧的首部

### 地址解析协议ARP

ARP的作用是：从网络层使用的IP地址中解析出在数据链路层使用的硬件地址

每个主机都设有一个ARP高速缓存，其中有所在局域网上的各主机和路由器的IP地址到硬件地址的映射表

主机A向主机B发送IP数据报时，现在其ARP高速缓存中查看有无主机B的IP地址和物理地址的映射条目
- 若有，就可查出其对应的硬件地址，再将此硬件地址写入MAC帧，然后通过局域网将该MAC帧发往此硬件地址
- 若无，ARP进程会在本局域网上广播发送一个ARP请求分组，收到ARP响应分组后，将此硬件地址写入MAC帧，并将得到的IP地址到硬件地址的映射写入ARP高速缓存

ARP高速缓存的作用是存放最近获得的IP地址到MAC地址的映射条目，以减少ARP广播的数量

ARP是解决同一个局域网上的主机或路由器的IP地址和硬件地址的映射问题，如果所要找的目的主机和源主机不在同一个局域网上，就要通过ARP找到一个位于本局域网上的某个路由器的硬件地址，把分组发送给路由器，让路由器把分组转发给下一个网络

### IP数据报的格式

一个IP数据报由首部和数据两部分组成，首部的前一部分是固定长度，共20字节，是所有IP数据报必须具有的

### IP层转发分组的流程

路由表是按主机所在的网络地址来制作的

在路由表中，对每一条路由，最主要的是（目的网络地址， 下一跳地址）

IP数据报的首部中没有地方可以用来指明下一跳路由器的IP地址

当路由器收到待转发的数据报，不是将下一跳路由器的IP地址填入IP数据报，而是送交下层的网络接口软件

网络接口软件使用ARP负责将下一跳路由器的IP地址转化为硬件地址，并将此硬件地址放在链路层的MAC帧的首部，然后根据硬件地址找到下一跳路由器

## 划分子网和构造超网

### 划分子网

这一阶段是把IP两级地址更新到三级地址的过程

#### 划分子网的基本思路

划分子网是一个单位内部的事情，单位对外仍表现为没有划分子网的网络

具体做法是：从主机号高位借用若干个位作为子网号，而主机号也就相应减少了若干位

凡是从其他网络发送给本单位某个主机的IP数据报，仍是根据目的网络号先找到本单位网络上的路由器，然后路由器按目的网络号和子网号找到目的子网

划分子网只是把IP地址的主机号这部分进行再划分，而不改变IP地址原来的网络号

划分子网的优点：
- 减少了IP地址的浪费
- 使网络的组织更加灵活
- 更便于维护和管理

#### 子网掩码

从一个IP数据报的首部并无法判断源主机或目的主机所连接的网络是否进行了子网划分，使用子网掩码可以找到IP地址中的子网部分

规则：
- 子网掩码长度为32位
- 某位为1，IP地址中的对应位为网络号和子网号
- 某位为0，IP地址中的对应位为主机号
- （IP地址）AND（子网掩码）=网络地址

### 使用子网时分组的转发

### 无分类编址CIDR

CIDR消除了传统的A、B、C类地址和划分子网的概念，使用各种长度的网络前缀来代替分类地址中的网络号和子网号

IP地址从三级编址又回到了两级编址

无分类的两级编址的记法是：网络前缀，主机号

CIDR使用斜线记法，又称为CIDR记法，即在IP地址后面加上一个"/"，然后协商网络前缀所占的位数（这个数值对应三级编址中子网掩码中1的个数）

CIDR把网络前缀都相同的连续的IP地址编成CIDR地址块

#### 路由聚合

一个CIDR地址块可以表示很多地址，这种地址的聚合也称为路由聚合，使得路由表中的一个项目可以表示很多个原来传统分类地址的路由

路由聚合也称为构成超网

#### 构成超网

前缀长度不超过23位的CIDR地址块都包含了多个C类地址，这些C类地址合起来就构成了超网

CIDR地址块中的地址数一定是2的整数次幂

网络前缀越短，其地址块所包含的地址数就越多

#### 最长前缀匹配

使用CIDR时，路由表中的每个项目由网络前缀和下一跳地址组成，在查找路由表时可能会得到不止一个匹配结果，应当从匹配结果中选择具有最长网络前缀的路由，网络前缀越长，其地址块就越小，因而路由就越具体

## 网际控制报文协议 ICMP

为了更有效的转发IP数据报和提高交付成功的机会，在网际层使用了网际控制报文协议

ICMP报文有两种：
- ICMP差错报文
- ICMP询问报文

ICMP报文的前4个字节是统一的格式，共有3个字段：类型、代码和检验和

### ICMP差错报文

共有四种：

1. 终点不可达
2. 时间超过
3. 参数问题
4. 改变路由（重定向）

### ICMP询问报文

共有两种：

1. 回送请求和回答报文
2. 时间戳请求和回答报文

### ICMP的应用举例

#### PING

ping用来测试两个主机之间的连通性

#### Traceroute

用来跟踪一个分组从源点到终点的路径